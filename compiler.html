<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>C 語言線上編譯器</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: #f4f6f9;
    }

    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .left-panel {
      width: 45%;
      background-color: white;
      padding: 30px;
      box-sizing: border-box;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }

    .left-panel h2 {
      color: #007bff;
    }

    .left-panel .section {
      margin-top: 20px;
    }

    .left-panel .section table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .left-panel .section table, th, td {
      border: 1px solid black;
    }

    .left-panel .section table th, .left-panel .section table td {
      padding: 8px;
      text-align: left;
    }

    .right-panel {
      width: 55%;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-header h3 {
      margin: 0;
      color: #007bff;
    }

    .editor-buttons button {
      margin-left: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }

    .editor-buttons .run {
      background-color: #4a90e2;
      color: white;
    }

    .editor-buttons .submit {
      background-color: #fd79a8;
      color: white;
    }

    #editor {
      width: 100%;
      height: 300px;
      margin-top: 10px;
      border: 1px solid #ccc;
    }

    #output-container {
      background-color: white;
      padding: 10px;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      flex-grow: 1;
      overflow-y: auto;
    }

    #output-container h3 {
      color: #007bff;
      margin: 0 0 10px 0;
    }

    #output {
      white-space: pre-wrap;
      color: #333;
    }

    .user-input {
      display: inline-block;
      min-width: 100px;
      border: none;
      background: none;
      color: limegreen;
      font-family: "Courier New", monospace;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <h2>題目敘述</h2>
      <div class="section">
        <p>學完所有你現在面對的第一個挑戰題，請寫一個程式，可以讓使用者輸入指定的字串，並且輸出指定的字串。例如：輸入字串 "world"，則顯示出 "hello, world"。</p>
      </div>
      <div class="section">
        <table>
          <tr><th colspan="2">輸入輸出</th></tr>
          <tr><td>輸入說明</td><td>輸入線共一行，內含一組文字</td></tr>
          <tr><td>輸出說明</td><td>輸出題目指定的文字</td></tr>
        </table>
      </div>
      <div class="section">
        <table>
          <tr><th>範例輸入</th><th>範例輸出</th></tr>
          <tr><td>world</td><td>hello, world</td></tr>
          <tr><td>c++</td><td>hello, c++</td></tr>
          <tr><td>Taiwan</td><td>hello, Taiwan</td></tr>
        </table>
      </div>
    </div>
    <div class="right-panel">
      <div class="editor-header">
        <h3>建議</h3>
        <div class="editor-buttons">
          <button class="run" onclick="runCode()">執行程式</button>
          <button class="submit" onclick="submitAnswer()">送出解答</button>
        </div>
      </div>
        <div id="editor">#include &lt;stdio.h&gt;
        int main() {
            printf("Hello World !\n");
            return 0;
        }
        </div>
      <div id="output-container">
        <h3>輸出結果：</h3>
        <div id="output"></div>
      </div>
    </div>
  </div>
  <script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/terminal");
    editor.session.setMode("ace/mode/c_cpp");

    let userInputs = [];
    let expectedInputs = [];
    let outputDiv = document.getElementById("output");
    let waitingForInput = false;
    let currentInputIndex = 0;

    async function runCode() {
      userInputs = [];
      expectedInputs = [];
      currentInputIndex = 0;
      waitingForInput = false;
      outputDiv.innerHTML = "";

      const code = editor.getValue();
      const lines = code.split("\n");

      let lastWasPrintf = false;
      let questionBuffer = null;

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();

        if (line.startsWith("printf")) {
          questionBuffer = line.match(/printf\(["'](.+?)["']\)/);
          lastWasPrintf = true;
        } else if (line.startsWith("scanf")) {
          let lineDiv = document.createElement("div");

          if (!lastWasPrintf) {
            outputDiv.appendChild(document.createElement("br"));
          }

          if (questionBuffer) {
            let promptSpan = document.createElement("span");
            promptSpan.innerText = questionBuffer[1] + " ";
            lineDiv.appendChild(promptSpan);
            questionBuffer = null;
          }

          let inputSpan = document.createElement("span");
          inputSpan.contentEditable = "true";
          inputSpan.className = "user-input";
          inputSpan.onkeypress = function (event) {
            handleUserInput(event, this);
          };

          lineDiv.appendChild(inputSpan);
          outputDiv.appendChild(lineDiv);
          expectedInputs.push(inputSpan);

          lastWasPrintf = false;
        }
      }

      if (expectedInputs.length > 0) {
        waitingForInput = true;
        expectedInputs[0].focus();
      }
    }

    function handleUserInput(event, inputElement) {
      if (event.key === "Enter" && waitingForInput) {
        event.preventDefault();
        let inputText = inputElement.innerText.trim();

        if (inputText === "") {
          alert("請輸入資料後再按 Enter！");
          return;
        }

        userInputs.push(inputText);
        inputElement.contentEditable = "false";
        currentInputIndex++;

        if (currentInputIndex < expectedInputs.length) {
          let emptyLine = document.createElement("br");
          outputDiv.appendChild(emptyLine);

          setTimeout(() => {
            expectedInputs[currentInputIndex].focus();
          }, 50);
        } else {
          waitingForInput = false;
          sendCodeToCompiler();
        }
      }
    }

    async function sendCodeToCompiler() {
      outputDiv.innerHTML += "<br>執行中...<br>";
      const code = editor.getValue();
      const stdin = userInputs.join("\n");
      console.log("[debug] 傳送中的程式碼：\n", code);
      console.log("[debug] 使用者輸入內容：\n", stdin);

      const response = await fetch("https://emkc.org/api/v2/piston/execute", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          language: "c",
          version: "*",
          files: [{ name: "main.c", content: editor.getValue() }],
          stdin: userInputs.join("\n")
        })
      });

      const result = await response.json();
      console.log("[debug] API 回傳結果：", result);
      let cleanOutput = result.run.output || result.run.stderr || "執行失敗";
      outputDiv.innerHTML += cleanOutput;
    }

    function submitAnswer() {
      alert("答案已送出！");
    }
  </script>
</body>
</html>
