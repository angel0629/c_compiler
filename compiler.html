<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C èªè¨€ç·šä¸Šç·¨è­¯å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://unpkg.com/web-tree-sitter@0.20.8/tree-sitter.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header> C èªè¨€ç·šä¸Šç·¨è­¯å™¨</header>
    <div class="main">
        <!-- é¡Œç›®å€ï¼ˆå·¦æ¬„ï¼‰ -->
        <div class="left-panel">
            <h2>é¡Œç›®æ•˜è¿°</h2>
            <div>
                <strong>å…§å®¹</strong>
                <p>å­¸å®Œæ‰€æœ‰ä½ ç¾åœ¨é¢å°çš„ç¬¬ä¸€å€‹æŒ‘æˆ°é¡Œï¼Œè«‹å¯«ä¸€å€‹ç¨‹å¼ï¼Œå¯ä»¥è®“ä½¿ç”¨è€…è¼¸å…¥æŒ‡å®šçš„å­—ä¸²ï¼Œä¸¦ä¸”è¼¸å‡ºæŒ‡å®šçš„å­—ä¸²ã€‚ä¾‹å¦‚ï¼šè¼¸å…¥å­—ä¸² "world"ï¼Œå‰‡é¡¯ç¤ºå‡º "hello, world"ã€‚</p>
            </div>
            <table>
                <tr><th colspan="2">è¼¸å…¥è¼¸å‡º</th></tr>
                <tr><td>è¼¸å…¥èªªæ˜</td><td>è¼¸å…¥ç·šå…±ä¸€è¡Œï¼Œå…§å«ä¸€çµ„æ–‡å­—</td></tr>
                <tr><td>è¼¸å‡ºèªªæ˜</td><td>è¼¸å‡ºé¡Œç›®æŒ‡å®šçš„æ–‡å­—ã€‚</td></tr>
            </table>
            <table>
                <tr><th>ç¯„ä¾‹è¼¸å…¥</th><th>ç¯„ä¾‹è¼¸å‡º</th></tr>
                <tr><td>world</td><td>hello, world</td></tr>
                <tr><td>c++</td><td>hello, c++</td></tr>
                <tr><td>Taiwan</td><td>hello, Taiwan</td></tr>
            </table>
        </div>

        <!-- ç·¨è¼¯å€ï¼ˆå³æ¬„ï¼‰ -->
        <div class="right-panel">
            <div class="button-bar">
                <h3>å³æ™‚èªæ³•æª¢æŸ¥</h3>
            </div>
            <div id="editor">#include &lt;stdio.h&gt;
int main() {
    printf("Hello World\n");
    return 0;
}</div>
            <div id="output">
                <h3>èªæ³•æª¢æŸ¥çµæœï¼š</h3>
                <div id="syntax-errors" style="color: red; margin-top: 10px;"></div>
                <div id="status-indicator"></div>
            </div>
        </div>
    </div>

    <script src="compiler.js"></script>
    <script>
        let parser = null;
        let C = null;
        let isInitialized = false;

        // ç­‰å¾… editor åˆå§‹åŒ–å®Œæˆå¾Œå†åˆå§‹åŒ– Tree-sitter
        function waitForEditor() {
            if (typeof editor !== 'undefined' && editor) {
                console.log('Editor å·²æº–å‚™å°±ç·’ï¼Œé–‹å§‹åˆå§‹åŒ– Tree-sitter...');
                initTreeSitter();
            } else {
                console.log('ç­‰å¾… Editor åˆå§‹åŒ–...');
                setTimeout(waitForEditor, 100);
            }
        }

        // åˆå§‹åŒ– Tree-sitter
        async function initTreeSitter() {
            try {
                console.log('é–‹å§‹åˆå§‹åŒ– Tree-sitter...');
                await TreeSitter.init();
                console.log('Tree-sitter æ ¸å¿ƒåˆå§‹åŒ–å®Œæˆ');
                
                console.log('æ­£åœ¨è¼‰å…¥ C èªè¨€èªæ³•æª”æ¡ˆ...');
                // å˜—è©¦ä¸åŒçš„è¼‰å…¥æ–¹å¼
                try {
                    C = await TreeSitter.Language.load('./tree-sitter-c.wasm');
                } catch (wasmError) {
                    console.warn('ç›´æ¥è¼‰å…¥ WASM å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–æ–¹å¼:', wasmError);
                    // å¦‚æœç›´æ¥è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ fetch
                    const response = await fetch('./tree-sitter-c.wasm');
                    const wasmBuffer = await response.arrayBuffer();
                    C = await TreeSitter.Language.load(wasmBuffer);
                }
                console.log('C èªè¨€èªæ³•æª”æ¡ˆè¼‰å…¥æˆåŠŸ');
                
                parser = new TreeSitter();
                parser.setLanguage(C);
                console.log('Tree-sitter C èªè¨€è§£æå™¨åˆå§‹åŒ–æˆåŠŸ');
                
                isInitialized = true;
                
                // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
                updateStatusIndicator(true);
                
                // è¨­å®šç·¨è¼¯å™¨èªæ³•æª¢æŸ¥
                setupSyntaxChecking();
                
                // åŸ·è¡Œåˆå§‹èªæ³•æª¢æŸ¥
                setTimeout(() => {
                    checkSyntax();
                    console.log('åˆå§‹èªæ³•æª¢æŸ¥å®Œæˆ');
                }, 1000);
                
            } catch (error) {
                console.error('Tree-sitter åˆå§‹åŒ–å¤±æ•—:', error);
                updateStatusIndicator(false, error.message);
            }
        }

        // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateStatusIndicator(success, errorMessage = '') {
            const statusDiv = document.getElementById('problem_output');
            if (success) {
                statusDiv.innerHTML = '<span style="color: green;">âœ“ Tree-sitter å·²å°±ç·’</span>';
                statusDiv.style.display = 'block';
            } else {
                statusDiv.innerHTML = `<span style="color: red;">âœ— åˆå§‹åŒ–å¤±æ•—: ${errorMessage}</span>`;
                statusDiv.style.display = 'block';
            }
        }

        // è¨­å®šèªæ³•æª¢æŸ¥
        function setupSyntaxChecking() {
            if (!editor) {
                console.warn('ç·¨è¼¯å™¨å°šæœªåˆå§‹åŒ–ï¼Œç„¡æ³•è¨­å®šèªæ³•æª¢æŸ¥');
                return;
            }
            
            console.log('è¨­å®šç·¨è¼¯å™¨èªæ³•æª¢æŸ¥ç›£è½å™¨...');
            // ç›£è½ç·¨è¼¯å™¨å…§å®¹è®ŠåŒ–
            editor.getSession().on('change', function() {
                if (isInitialized) {
                    setTimeout(checkSyntax, 500); // å»¶é² 500ms é¿å…éæ–¼é »ç¹æª¢æŸ¥
                }
            });
            console.log('èªæ³•æª¢æŸ¥ç›£è½å™¨è¨­å®šå®Œæˆ');
        }

        // æª¢æŸ¥èªæ³•
        function checkSyntax() {
            if (!parser || !isInitialized) {
                console.warn('è§£æå™¨å°šæœªåˆå§‹åŒ–ï¼Œè·³éèªæ³•æª¢æŸ¥');
                return;
            }
            
            const code = editor.getValue();
            console.log('æ­£åœ¨æª¢æŸ¥èªæ³•...', code.substring(0, 50) + '...');
            
            const tree = parser.parse(code);
            const errors = [];
            
            // æª¢æŸ¥èªæ³•éŒ¯èª¤
            const query = C.query(`
                (ERROR) @error
                (preproc_function_def) @warning
            `);
            
            const captures = query.captures(tree.rootNode);
            console.log('èªæ³•æª¢æŸ¥çµæœ:', captures.length, 'å€‹å•é¡Œ');
            
            captures.forEach(capture => {
                const node = capture.node;
                const type = capture.name;
                
                if (type === 'error') {
                    errors.push({
                        type: 'èªæ³•éŒ¯èª¤',
                        line: node.startPosition.row + 1,
                        message: 'èªæ³•éŒ¯èª¤'
                    });
                }
            });
            
            // é¡¯ç¤ºéŒ¯èª¤
            displayErrors(errors);
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function displayErrors(errors) {
            const errorDiv = document.getElementById('syntax-errors');
            
            if (errors.length === 0) {
                errorDiv.innerHTML = '<span style="color: green;">âœ“ èªæ³•æª¢æŸ¥é€šé</span>';
                console.log('èªæ³•æª¢æŸ¥é€šé');
                
                // æ¸…é™¤ Tree-sitter éŒ¯èª¤æ¨™è¨˜ï¼Œä¿ç•™ GCC æ¨™è¨˜
                if (typeof editor !== 'undefined' && editor) {
                    const currentAnnotations = editor.session.getAnnotations();
                    const gccAnnotations = currentAnnotations.filter(ann => ann.source === 'gcc');
                    editor.session.setAnnotations(gccAnnotations);
                }
                
                // æ¸…é™¤è¼¸å‡ºå€åŸŸä¸­çš„ GCC éŒ¯èª¤è¨Šæ¯ï¼ˆå¦‚æœ Tree-sitter é€šéä½† GCC å¯èƒ½é‚„æœ‰éŒ¯èª¤ï¼‰
                if (typeof window.outputDiv !== 'undefined' && window.outputDiv) {
                    const outputContent = window.outputDiv.innerHTML;
                    // ç§»é™¤åŒ…å« "ğŸ›‘ GCC èªæ³•éŒ¯èª¤ï¼š" çš„è¡Œï¼ˆæ›´ç²¾ç¢ºçš„åŒ¹é…ï¼‰
                    const cleanedContent = outputContent.replace(/<br><span style="color: red;">ğŸ›‘ GCC èªæ³•éŒ¯èª¤ï¼š<\/span><br><span style="color: red;">[^<]*<\/span>/g, '');
                    // ç§»é™¤åŒ…å« "ğŸ›‘ GCC èªæ³•æª¢æŸ¥æœå‹™éŒ¯èª¤ï¼š" çš„è¡Œ
                    const finalContent = cleanedContent.replace(/<br><span style="color: red;">ğŸ›‘ GCC èªæ³•æª¢æŸ¥æœå‹™éŒ¯èª¤ï¼š[^<]*<\/span>/g, '');
                    window.outputDiv.innerHTML = finalContent;
                }
            } else {
                let errorHtml = '<h4>èªæ³•æª¢æŸ¥çµæœï¼š</h4>';
                errors.forEach(error => {
                    errorHtml += `<div style="margin: 5px 0;">
                        <span style="color: red;">â— ç¬¬ ${error.line} è¡Œ: ${error.message}</span>
                    </div>`;
                });
                
                errorDiv.innerHTML = errorHtml;
                console.log('ç™¼ç¾èªæ³•éŒ¯èª¤:', errors);
                
                // æ·»åŠ  Tree-sitter éŒ¯èª¤æ¨™è¨˜åˆ°ç·¨è¼¯å™¨
                if (typeof editor !== 'undefined' && editor) {
                    const treeSitterAnnotations = errors.map(error => ({
                        row: error.line - 1, // ACE ç·¨è¼¯å™¨è¡Œè™Ÿå¾ 0 é–‹å§‹
                        column: 0,
                        text: error.message,
                        type: 'error',
                        source: 'tree-sitter'
                    }));
                    
                    const currentAnnotations = editor.session.getAnnotations();
                    const gccAnnotations = currentAnnotations.filter(ann => ann.source === 'gcc');
                    const allAnnotations = [...gccAnnotations, ...treeSitterAnnotations];
                    editor.session.setAnnotations(allAnnotations);
                }
            }
        }

        // æ¸¬è©¦å‡½æ•¸ - å¯ä»¥åœ¨æ§åˆ¶å°å‘¼å«
        window.testTreeSitter = function() {
            console.log('=== Tree-sitter æ¸¬è©¦ ===');
            console.log('åˆå§‹åŒ–ç‹€æ…‹:', isInitialized);
            console.log('è§£æå™¨:', parser);
            console.log('C èªè¨€èªæ³•:', C);
            console.log('Editor:', editor);
            
            if (parser && C) {
                const testCode = 'int main() { return 0; }';
                const tree = parser.parse(testCode);
                console.log('æ¸¬è©¦è§£æçµæœ:', tree.rootNode.toString());
                return true;
            }
            return false;
        };

        // é é¢è¼‰å…¥æ™‚ç­‰å¾… editor åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œç­‰å¾… Editor åˆå§‹åŒ–...');
            waitForEditor();
        });

        // å…¨åŸŸè®Šæ•¸ä¾›å…¶ä»–è…³æœ¬ä½¿ç”¨
        window.checkSyntax = checkSyntax;
        window.initTreeSitter = initTreeSitter;
    </script>
</body>
</html>
